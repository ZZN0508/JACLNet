define(["require","exports","tslib","modules/core/i18n","proto_utils/unpack","modules/core/exception","modules/clean/web_timing_logger","dropbox/proto/js_init_data/privacy_consent/privacy_consent","modules/clean/marketing_tracker","modules/clean/analytics"],(function(e,t,o,i,n,r,a,s,c,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.init_async=t.initialize_module=t.moduleInit=t.PrivacyConsentPlatform=t.PrivacyConsentPlatformSingleton=void 0;var u,d;(function(e){e.StrictlyNecessary="strictly necessary",e.MarketingAdvertising="general marketing and advertising",e.Analytics="analytics",e.PerformanceFunctionality="performance and functionality",e.SocialMediaAdvertising="social media advertising",e.AllCookies="all"})(u||(u={})),(function(e){e[e.OptIn=1]="OptIn"})(d||(d={}));var p=(function(){function e(){var e=this;return this.bannerVisible=!1,this.optionsButtonLoaded=!1,this.isFooterLoading=!1,this.receiveMessage=function(t){var o,i,n,r,a=e.iframeEl,s=t.data;if(t.source===a.contentWindow){var c={},l=!1;switch(s.message_type){case"BODY_CONTENT_CHANGE":var u=s.bannerVisible,d=s.dialogVisible,p=s.optionsButtonVisible,g=s.optionsButtonLoaded,m=!u&&!d&&!p;if(null===(o=e.iframeEl)||void 0===o||o.classList.toggle("banner-visible",u),null===(i=e.iframeEl)||void 0===i||i.classList.toggle("dialog-open",d),e.bannerVisible=u,g&&!e.optionsButtonLoaded&&(e.optionsButtonLoaded=!0,e.setupSettingsReEntry()),m?(e.setIframeHeight("0"),e.setIframeWidth("0")):null===(n=e.iframeEl)||void 0===n||n.removeAttribute("hidden"),u?(e.addLocaleSelectorMargin(),e.hasUserInteracted()||e.bakeCookie(e.createShadowCookieValue(e.mapCookies({}),!1))):e.removeLocaleSelectorMargin(),p){var f="true"===sessionStorage.getItem("cookie-settings-minimized");null===(r=e.iframeEl)||void 0===r||r.classList.toggle("prev-collapsed",f)}else e.clearIframeMinimizeClass();break;case"BANNER_RESIZE":s.bannerHeight&&s.bannerHeight!==a.height&&(e.setIframeHeight(s.bannerHeight),e.addLocaleSelectorMargin());break;case"DISPLAY_BUTTON":!e.manageCookiesSet&&s.buttonHeight&&s.buttonWidth&&(e.setIframeHeight(s.buttonHeight),e.setIframeWidth(s.buttonWidth));break;case"PRIOR_CONSENT":c=e.mapCookies(s.categories),l=e.havePreferencesChanged(c),e.hasUserInteracted()&&!l||(e.bakeCookie(e.createShadowCookieValue(e.mapCookies(s.categories),!0)),e.reloadPage());break;case"CONSENT_CHANGED":case"CONSENT_WITHDRAWN":c=e.mapCookies(s.categories),l=e.havePreferencesChanged(c),e.bakeCookie(e.createShadowCookieValue(c,!0)),l&&e.reloadPage();break;case"CONSENT_DECLINED":e.bakeCookie(e.createShadowCookieValue(e.mapCookies(s.categories),!0));break;case"SCRIPT_LOADED":e.logToUXA("privacy_consent_script_loaded",{script_id:s.scriptId,script_url:s.scriptUrl});break;case"SCRIPT_LOAD_ERROR":e.logToUXA("privacy_consent_script_load_error",{script_id:s.scriptId,script_url:s.scriptUrl});break;case"TOGGLE_BUTTON_MINIMIZE":e.onToggleButtonMinimize(s.buttonMinimized)}}},t.PrivacyConsentPlatform?t.PrivacyConsentPlatform:this}return e.prototype.init=function(e){var t,o=this;this.config=e,this.updateTealiumDataLayer(),e.iframeOrigin&&!this.iframeEl&&(this.iframeSrc="https://"+e.iframeOrigin,this.iframeStartTime=new Date,this.iframeEl=this.createIframe(),null===(t=this.iframeEl)||void 0===t||t.addEventListener("load",(function(){o.handleIframeLoad(o.iframeStartTime,e.iframeOrigin)})),window.addEventListener("message",this.receiveMessage,!1))},e.prototype.handleIframeLoad=function(e,t){var o=this;this.logToUXA("privacy_consent_iframe_loaded",{total_time:((new Date).valueOf()-e.valueOf()).toString(),iframe_uri:t}),a.waitForTTI().then((function(){o.sendCountryCode(),o.setupSettingsReEntry()}))},e.prototype.onFooterLoaded=function(){this.setupSettingsReEntry(),this.bannerVisible&&this.addLocaleSelectorMargin()},e.prototype.setupSettingsReEntry=function(){this.setManageCookies(),this.maybeUseFloatingButton()},e.prototype.maybeUseFloatingButton=function(){!this.iframeEl||this.manageCookiesSet||this.isFooterLoading||this.sendShowFloatingButton()},e.prototype.createIframe=function(){var e=document.createElement("iframe");return e.src=this.iframeSrc,e.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-forms"),e.setAttribute("class","consent-iframe"),e.setAttribute("id","consent-iframe"),e.setAttribute("allowTransparency","true"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("hidden","true"),e.setAttribute("title",i.intl.formatMessage({id:"ulDVPi",defaultMessage:"Dropbox Consent"})),e.setAttribute("tabindex","1"),document.body.insertBefore(e,document.body.childNodes[0]),e},e.prototype.openOptionsDialog=function(){var e,t;null===(t=null===(e=this.iframeEl)||void 0===e?void 0:e.contentWindow)||void 0===t||t.postMessage({message_type:"OPEN_OPTIONS_DIALOG"},this.iframeSrc)},e.prototype.addLocaleSelectorMargin=function(){var e=document.getElementById("locale-container");this.iframeEl&&e&&(e.style.marginBottom=parseInt(this.iframeEl.height,10)+16+"px")},e.prototype.removeLocaleSelectorMargin=function(){var e=document.getElementById("locale-container");e&&e.style.removeProperty("margin-bottom")},e.prototype.sendShowFloatingButton=function(){var e,t;null===(t=null===(e=this.iframeEl)||void 0===e?void 0:e.contentWindow)||void 0===t||t.postMessage({message_type:"SHOW_FLOATING_BUTTON"},this.iframeSrc)},e.prototype.setIframeHeight=function(e){this.iframeEl.height=e},e.prototype.setIframeWidth=function(e){this.iframeEl.width=e},e.prototype.getCookieStr=function(e){try{return String(document.cookie||"").split(";").map((function(e){return e.split("=")})).map((function(e){return[e[0],e.slice(1).join(";")].map((function(e){return e.replace(/^[ \t]+|[ \t]+$/g,"")}))})).reduce((function(e,t){var i,n=t[0],r=t[1];return o.__assign(o.__assign({},e),((i={})[n]=r,i))}),Object.create({}))[e]||""}catch(e){return""}},e.prototype.getCurrentCookieObj=function(){var e=this.getCookieStr("__Secure-dbx_consent");if(e)try{return JSON.parse(e)}catch(t){return r.reportException({err:new Error("Consent cookie could not be parsed"),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"],exc_extra:{cookie_str:e}}),null}return{}},e.prototype.createShadowCookieValue=function(e,t){var o=this.getCurrentCookieObj(),i=o.consentDate?new Date(o.consentDate):new Date,n=new Date(i);return n.setMonth(i.getMonth()+6),{consentType:d.OptIn,consentDate:i.toISOString(),expireDate:n.toISOString(),consentMonths:6,categories:e,userInteracted:!!o.userInteracted||t,numDots:1}},e.prototype.bakeCookie=function(e){var t,o=(new Date(e.expireDate).getTime()-(new Date).getTime())/1e3,i=((t={})["__Secure-dbx_consent"]=JSON.stringify(e).replace(/[;]|[^ -~]/g,(function(e){return"\\u"+(65536+e.charCodeAt(0)).toString(16).substr(1)})),t.domain="dropbox.com",t.path="/",t["max-age"]=o.toString(),t.samesite="lax",t.secure="",t),n=Object.keys(i).map((function(e){return i[e]?e+"="+i[e]:""+e}));document.cookie=n.join(";")},e.prototype.updateTealiumDataLayer=function(){var e=this.getCurrentCookieObj(),t=null==e?void 0:e.categories,i=Object.keys(u),n=[];t&&(t[u.AllCookies]?n=o.__spreadArrays(i):i.forEach((function(e){t[u[e]]&&n.push(e)}))),c.MarketingTracker.pushWithDefaults({consent_categories:n.join(",")})},e.prototype.reloadPage=function(){window.location.reload(!0)},e.prototype.hasUserInteracted=function(){var e;return!!(null===(e=this.getCurrentCookieObj())||void 0===e?void 0:e.userInteracted)},e.prototype.havePreferencesChanged=function(e){var t=this.getCurrentCookieObj();if(t)try{var o=JSON.stringify(t.categories);return JSON.stringify(e)!==o}catch(e){return r.reportException({err:new Error("Consent cookie could not be parsed"),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"],exc_extra:{cookie_str:this.getCookieStr("__Secure-dbx_consent")}}),!1}return!0},e.prototype.mapCookies=function(e){var t={};for(var o in e)if(e.hasOwnProperty(o)){var i=o.toLowerCase();Object.values(u).includes(i)?t[i]=e[o]:r.reportException({err:new Error("Invalid cookie category id"),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"],exc_extra:{cookie_id:i}})}return t},e.prototype.clearIframeMinimizeClass=function(){var e;null===(e=this.iframeEl)||void 0===e||e.classList.remove("prev-collapsed","collapsed","expanded")},e.prototype.onToggleButtonMinimize=function(e){var t,o,i,n;null===(t=this.iframeEl)||void 0===t||t.classList.remove("prev-collapsed"),null===(o=this.iframeEl)||void 0===o||o.classList.toggle("collapsed",e),null===(i=this.iframeEl)||void 0===i||i.classList.toggle("expanded",!e),sessionStorage.setItem("cookie-settings-minimized",(null===(n=this.iframeEl)||void 0===n?void 0:n.classList.contains("collapsed"))?"true":"false")},e.prototype.sendCountryCode=function(){var e,t,o;(null===(e=this.config)||void 0===e?void 0:e.countryCode)&&(null===(o=null===(t=this.iframeEl)||void 0===t?void 0:t.contentWindow)||void 0===o||o.postMessage({message_type:"COUNTRY_CODE",country_code:this.config.countryCode},this.iframeSrc))},e.prototype.logToUXA=function(e,t){l.UXAnalyticsLogger.log(e,t)},e.prototype.findManageCookies=function(){var e=document.querySelectorAll('a[href="/#manage-cookies"]');return e.length?e[0]:null},e.prototype.setManageCookies=function(){var e=this;if(this.config){var t=this.findManageCookies();t&&(t.onclick=function(t){t.preventDefault(),e.openOptionsDialog()},this.manageCookiesSet=!0)}},e})();t.PrivacyConsentPlatformSingleton=p,t.PrivacyConsentPlatform=new p,t.moduleInit=function(e){var o=n.unpackProto(e,s.privacy_consent.PrivacyConsentInitData);t.PrivacyConsentPlatform.init(o)},t.initialize_module=function(e){t.PrivacyConsentPlatform.init(e)},t.init_async=function(e){t.PrivacyConsentPlatform.config||t.PrivacyConsentPlatform.init(e)}}));
//# sourceMappingURL=privacy_consent.min.js-vflQD2464.map
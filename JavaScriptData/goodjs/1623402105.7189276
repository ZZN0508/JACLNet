define(["./helper","local/common/push/pushAppSingleton","local/common/components/nsglibCommon"],function(e,o,t){return{init:function(){var i=o.getInstance(),a=e.getSystem(),r=e.getBrowser(),n=!0,s=5e3,c=!0,d=15e3,l=null,u=3,m=500;"permissions"in navigator&&navigator.permissions.query({name:"notifications"}).then(function(o){o.onchange=function(){e.localStorage.removeItem("notificationsPermissionTTL")}});var p=document.querySelector(".notificationPrompt");if(p)var v=p.querySelector(".popupNotif"),h=p.querySelector(".thankPrompt"),f=p.querySelector(".thankPrompt2"),y=p.querySelector(".tutorialPrompt"),g=p.querySelector(".infoSystemPrompt"),w=p.querySelector(".glsPush"),S=p.querySelector(".popupTopicSelection"),P=document.querySelector(".notificationTopicsPlaceholder");var C=e.localStorage.getItem("sg.push.tutorialPrompt");function B(){var o,c,d,l,u,m,w,B,b;if(p&&v&&h&&y&&g&&S)switch(o=v.querySelector(".popupNotif .popupCloseIcon"),c=v.querySelector(".popupNotif .popupClose"),d=v.querySelector(".bellIcon"),l=v.querySelector("div.accept"),u=S.querySelector(".popupCloseIcon"),m=S.querySelector(".form button.save"),t.domBuilder.addEvent(o,"click",x),t.domBuilder.addEvent(c,"click",x),t.domBuilder.addEvent(d,"click",R),t.domBuilder.addEvent(l,"click",H),t.domBuilder.addEvent(u,"click",O),t.domBuilder.addEvent(m,"click",D),function(){var e=y.querySelector(".tutorialPrompt .popupCloseIcon");if(t.domBuilder.addEvent(e,"click",U),"Windows"===a&&"firefox"===r){var o=y.querySelector(".firefoxwindows");t.domBuilder.removeClass(o,"hide")}if("MacOsX"===a&&"firefox"===r){var i=y.querySelector(".firefoxmacosx");t.domBuilder.removeClass(i,"hide")}if(("Windows"===a||"MacOsX"===a)&&"chrome"===r){var n=y.querySelector(".chromemacosxwindows");t.domBuilder.removeClass(n,"hide")}}(),w=h.querySelector(".thankPrompt .popupCloseIcon"),B=f.querySelector(".thankPrompt2 .popupCloseIcon"),b=f.querySelector(".thankPrompt2 span"),t.domBuilder.addEvent(w,"click",M),t.domBuilder.addEvent(B,"click",F),t.domBuilder.addEvent(b,"click",G),e.localStorage.getItem("sg.push.notificationsPermission")){case"denied":switch(Notification.permission){case"denied":L();break;case"default":I(),L();break;case"granted":"visited"===C&&(e.localStorage.setItem("sg.push.tutorialPrompt","promoted"),P?i.on("onReady",q):i.on("onReady",function(){k(!0)})),e.localStorage.setItem("sg.push.notificationsPermission","granted")}break;case null:case void 0:switch(Notification.permission){case"default":I();break;case"denied":e.localStorage.setItem("sg.push.notificationsPermission","denied"),L();break;case"granted":e.localStorage.setItem("sg.push.notificationsPermission","granted"),P&&i.on("onReady",q)}break;case"granted":switch(Notification.permission){case"default":case"denied":e.localStorage.setItem("sg.push.notificationsPermission","denied"),L();break;default:"visited"===C&&(e.localStorage.setItem("sg.push.tutorialPrompt","promoted"),function(){var e=p.querySelector(".active");e&&t.domBuilder.removeClass(e,"active");t.domBuilder.addClass(h,"active"),t.domBuilder.removeClass(v,"bellActive"),t.domBuilder.removeClass(v,"bellReady"),window.dataLayer.push({category:"ThankPromptShow",event:"Push"}),!0===n&&setTimeout(function(){t.domBuilder.removeClass(h,"active")},s)}()),P&&"granted"===Notification.permission&&i.on("onReady",q)}}}function q(){var e=document.createElement("div");t.domBuilder.addClass(e,"notificationPrompt"),P.innerHTML="",P.appendChild(e),t.domBuilder.addClass(e,"active"),e.appendChild(S);var o=S.querySelector("button.save");function i(){o.removeEventListener("click",i),t.domBuilder.removeClass(e,"active"),t.domBuilder.removeClass(S,"active"),t.domBuilder.removeClass(P,"active"),p.appendChild(S)}o&&o.addEventListener("click",i),require(["local/common/push/topics"],function(e){e.getTopics().then(function(e){if(!e)throw new Error;window.dataLayer.push({category:"showTopicsInPlaceholderDesktop",event:"Push"}),T({topics:e}),t.domBuilder.addClass(P,"active"),t.domBuilder.addClass(S,"active")}).catch(function(){window.dataLayer.push({category:"showTopicsInPlaceholderDesktopError",event:"Push"}),i()})})}function b(e){var o=e.querySelectorAll("input:checked"),i=[],a=0;for(o.length;item=o[a];a++)i.push({displayName:item.dataset.displayName,codeName:item.dataset.codeName});require(["local/common/push/pushPlatformApi"],function(e){e.sendTokenToServer(i).then(function(e){setTimeout(function(){t.domBuilder.removeClass(S,"active"),function(){var e=p.querySelector(".active");e&&t.domBuilder.removeClass(e,"active");t.domBuilder.addClass(f,"active"),window.dataLayer.push({category:"ThankPromptShow",event:"Push"}),c&&(l=setTimeout(function(){t.domBuilder.removeClass(f,"active")},d))}()},500)}).catch(function(e){t.domBuilder.removeClass(S,"active")})})}function k(e){t.domBuilder.addClass(S,"active"),require(["local/common/push/topics"],function(o){o.getTopics().then(function(o){if(!o)throw new Error;window.dataLayer.push({category:"OnetPopupTopicsShow",event:"Push"}),T({topics:o,firstLoad:e})}).catch(function(e){console.log(e),window.dataLayer.push({category:"OnetPopupTopicsError",event:"Push"}),t.domBuilder.removeClass(S,"active")})})}function T(e){var o=e.topics||!1,t=e.firstLoad||!1,i=S.querySelector(".form .topics"),a=i.querySelector("div.topic"),r=document.createDocumentFragment(),n=0;for(o.length;item=o[n];n++){var s=a.cloneNode(!0),c=s.querySelector("input"),d=s.querySelector("label");s.style.display="block",s.querySelector(".displayName").innerHTML=item.displayName,c.dataset.displayName=item.displayName,c.dataset.codeName=item.codeName,c.checked=item.subscribed||t&&item.codeName.indexOf("wiadomosci")>-1,c.id+=n,d.setAttribute("for",c.getAttribute("id")),r.appendChild(s)}i.innerHTML="",i.appendChild(r),i=null,a=null}function I(){var o=(new Date).setHours(0,0,0,0);if(0!==+(e.localStorage.getItem("notificationsPermissionTTL")||0)-o){var i=p.querySelector(".active");i&&t.domBuilder.removeClass(i,"active"),t.domBuilder.addClass(v,"active"),window.dataLayer.push({category:"OnetPromptShow",event:"Push"})}}function L(o){if(function(o){var t,i,a;switch(o){case"choiceTopics":t="sg.push.showbellchoiceday",i="sg.push.showbellchoicecnt",a=m;break;default:t="sg.push.showbellday",i="sg.push.showbellcnt",a=u}var r=(new Date).getDay(),n=e.localStorage.getItem(t);n=n?parseInt(n,10):null;var s=e.localStorage.getItem(i);if(s=s?parseInt(s,10):0,n===r){if(s>=a)return!1;s+=1}else s=1;return e.localStorage.setItem(i,s),e.localStorage.setItem(t,r),!0}(o)){var i=p.querySelector(".active");i&&t.domBuilder.removeClass(i,"active"),t.domBuilder.addClass(v,"bellActive")}}function N(){if("firefox"===r){var e=g.querySelector(".buttonLabel");e&&(e.innerHTML="&bdquo;Odbieraj&rdquo;"),t.domBuilder.addClass(g,"show"),w&&t.domBuilder.removeClass(w,"hide"),setTimeout(function(){E()},1e4)}}function E(){t.domBuilder.removeClass(g,"show"),w&&t.domBuilder.addClass(w,"hide")}function A(){i.on("onPermissionGranted",function(){window.dataLayer.push({category:"Subscribed",event:"Push"}),E(),k(!0),e.localStorage.setItem("sg.push.tutorialPrompt","promoted"),e.localStorage.setItem("sg.push.notificationsPermission","granted"),e.localStorage.removeItem("notificationsPermissionTTL")}),i.on("onPermissionDenied",function(){window.dataLayer.push({category:"Unsubscribed",event:"Push"}),E(),e.localStorage.removeItem("notificationsPermissionTTL")}),require(["local/common/push/tokenApi"],function(e){e.subscribe()}),window.dataLayer.push({category:"SystemPromptShow",event:"Push"})}function O(){window.dataLayer.push({category:"OnetPromptChoiceTopicsClose",event:"Push"}),t.domBuilder.removeClass(S,"active"),L("choiceTopics")}function D(){window.dataLayer.push({category:"OnetPromptChoiceTopicsSubscribe",event:"Push"}),b(S.querySelector(".topics"))}function x(){t.domBuilder.addClass(v,"bellActive"),e.localStorage.setItem("sg.push.notificationsPermission","denied"),setTimeout(function(){t.domBuilder.addClass(v,"bellReady")},100),window.dataLayer.push({category:"OnetPromptClose",event:"Push"}),e.localStorage.setItem("notificationsPermissionTTL",(new Date).setHours(0,0,0,0))}function R(){switch(window.dataLayer.push({category:"BellFABClick",event:"Push"}),Notification.permission){case"default":A(),N();break;case"denied":(o=p.querySelector(".active"))&&t.domBuilder.removeClass(o,"active"),e.localStorage.setItem("sg.push.tutorialPrompt","visited"),t.domBuilder.addClass(y,"active"),window.dataLayer.push({category:"TutorialPromptShow",event:"Push"});break;case"granted":k()}var o;t.domBuilder.removeClass(v,"bellActive"),t.domBuilder.removeClass(v,"bellReady"),t.domBuilder.removeClass(v,"active")}function H(){window.dataLayer.push({category:"OnetPromptAccept",event:"Push"}),e.localStorage.setItem("sg.push.notificationsPermission","granted"),A(),N();var o=p.querySelector(".active");o&&t.domBuilder.removeClass(o,"active")}function M(){window.dataLayer.push({category:"ThankPromptClose",event:"Push"}),t.domBuilder.removeClass(h,"active")}function F(){window.dataLayer.push({category:"ThankPromptClose",event:"Push"}),t.domBuilder.removeClass(f,"active"),clearTimeout(l)}function G(){window.dataLayer.push({category:"ThankPromptClickOnAction",event:"Push"}),k(),F()}function U(){window.dataLayer.push({category:"TutorialPromptClose",event:"Push"}),t.domBuilder.removeClass(y,"active")}return{init:function(){"Notification"in window&&(i.on("onRegister",B),i.on("onShowNotification",function(e,o){var t=JSON.parse(o.data);require(["local/common/push/sendToAnalytics","local/common/push/getPushId"],function(e,o){e({cd1:"OnetSGDesktop",cd2:o(t.openUrl||""),cd3:t.title})})}),i.run())}}}().init}});
define(["OK/utils/throttle","OK/utils/dom"],(function(t,e){"use strict";var i=[],n=!1,s=t(100,(function(){i.forEach((function(t){t.calculate()}))}));function o(t){var e=null;return i.some((function(i){if(i.element===t)return e=i,!0})),e}function r(t,e){var i=t.indexOf(e);i>-1&&t.splice(i,1)}function c(t,e,i,n){this.element=t,this.container=e,this.callback=i,this.predicate=n?n.bind(this):null}function l(e){this.element=e,this.items=[],this.listener=t(100,this.calculate.bind(this)),this.element.addEventListener("scroll",this.listener),this.updateRect()}return c.prototype={destroy:function(){this.container=null},isInViewport:function(){var t,e=this.container.rect,i=e.top,n=e.bottom;try{t=this.element.getBoundingClientRect()}catch(e){t={top:0,right:0,bottom:0,left:0,width:0,height:0}}return t.top>=i&&t.top<=n||t.bottom>=i&&t.bottom<=n},calculate:function(){var t=this.predicate?this.predicate():this.isInViewport();this.visible!==t&&(this.visible=t,this.callback.call(this.element,t))}},l.prototype={add:function(t){this.items.push(t),this.updateRect(),t.calculate()},updateRect:function(){this.rect=this.element.getBoundingClientRect()},remove:function(t){var e=null;this.items.forEach((function(i){if(i.element===t)return e=i,!0})),e&&(e.destroy(),r(this.items,e))},isEmpty:function(){return 0===this.items.length},isLast:function(t){return this.items[this.items.length-1]===t},calculate:function(){this.updateRect(),this.items.forEach((function(t){t.calculate()}))},destroy:function(){this.element.removeEventListener("scroll",this.listener)}},{add:function(t,r,u){var a,h=e.parent(t,"js-viewport-container");null===h&&(h=window),(a=o(h))||(a=new l(h),i.push(a)),a.add(new c(t,a,r,u)),n||(window.addEventListener("resize",s),n=!0)},remove:function(t){var c,l=e.parent(t,"js-viewport-container");null===l&&(l=window),(c=o(l))&&(c.remove(t),c.isEmpty()&&(c.destroy(),r(i,c))),n&&0===i.length&&(window.removeEventListener("resize",s),n=!1)},getContainer:function(t){return o(e.parent(t,"js-viewport-container"))}}}));
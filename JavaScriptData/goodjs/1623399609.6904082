var autoComplete=function(){function autoComplete(options){if(document.querySelector){var o={selector:0,source:0,minChars:3,delay:150,cache:1,menuClass:"",cacheMax:3e3,minSuggestionsBoxSize:250,renderItem:function(item,search){search=search.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");var re=new RegExp("("+search.split(" ").join("|")+")","gi");return'<div class="autocomplete-suggestion" data-val="'+item+'">'+item.replace(re,"<b>$1</b>")+"</div>"},filterItems:function(data,val){return data},onSelect:function(e,term,item){}};for(var k in options)options.hasOwnProperty(k)&&(o[k]=options[k]);for(var header="",footer="",elems="object"==typeof o.selector?[o.selector]:document.querySelectorAll(o.selector),i=0;i<elems.length;i++){var that=elems[i];that.sc=document.createElement("div"),that.sc.className="autocomplete-suggestions "+o.menuClass,that.autocompleteAttr=that.getAttribute("autocomplete"),that.setAttribute("autocomplete","off"),that.cache=[],that.searches=[],that.last_val="",enterUseSuggestion=!1,that.updateSC=function(resize,next){var rect=that.getBoundingClientRect();if(that.sc.style.left=rect.left+(window.pageXOffset||document.documentElement.scrollLeft)+"px",that.sc.style.top=rect.bottom+(window.pageYOffset||document.documentElement.scrollTop)+1+"px",rect.right-rect.left>=o.minSuggestionsBoxSize?that.sc.style.width=rect.right-rect.left+"px":that.sc.style.width=o.minSuggestionsBoxSize+"px",!resize&&that.sc.querySelector(".autocomplete-suggestion")&&(that.sc.style.display="block",that.sc.maxHeight||(that.sc.maxHeight=parseInt((window.getComputedStyle?getComputedStyle(that.sc,null):that.sc.currentStyle).maxHeight)),that.sc.suggestionHeight||(that.sc.suggestionHeight=that.sc.querySelector(".autocomplete-suggestion").offsetHeight),that.sc.suggestionHeight))if(next){var scrTop=that.sc.scrollTop,selTop=next.getBoundingClientRect().top-that.sc.getBoundingClientRect().top;selTop+that.sc.suggestionHeight-that.sc.maxHeight>0?that.sc.scrollTop=selTop+that.sc.suggestionHeight+scrTop-that.sc.maxHeight:selTop<0&&(that.sc.scrollTop=selTop+scrTop)}else that.sc.scrollTop=0},addEvent(window,"resize",that.updateSC),document.body.appendChild(that.sc),live("autocomplete-suggestion","mouseleave",(function(e){var sel=that.sc.querySelector(".autocomplete-suggestion.hover");sel&&setTimeout((function(){sel.className=sel.className.replace("hover","")}),20),enterUseSuggestion=!1}),that.sc),live("autocomplete-suggestion","mouseover",(function(e){var sel,sel;(sel=that.sc.querySelector(".autocomplete-suggestion.hover"))&&(sel.className=sel.className.replace("hover","")),this.className+=" hover",(sel=that.sc.querySelector(".autocomplete-footer.hover"))&&(sel.className=sel.className.replace(" hover","")),enterUseSuggestion=!1}),that.sc),live("autocomplete-suggestion","mousedown",(function(e){if(hasClass(this,"autocomplete-suggestion")){var v=this.getAttribute("data-val");that.value=v,o.onSelect(e,v,this),setTimeout((function(){that.sc.style.display="none"}),250)}}),that.sc),live("autocomplete-footer","mousedown",(function(e){if(hasClass(this,"autocomplete-footer")){var v=this.getAttribute("data-val");o.onSelect(e,v,this),setTimeout((function(){that.sc.style.display="none"}),250)}}),that.sc),live("autocomplete-footer","mouseover",(function(e){var sel=that.sc.querySelector(".autocomplete-suggestion.hover");sel&&(sel.className=sel.className.replace(" hover","")),this.className+=" hover",enterUseSuggestion=!1}),that.sc),that.blurHandler=function(e){var over_sb=document.querySelector(".autocomplete-suggestions.hover"),over_ft=document.querySelector(".autocomplete-footer.hover"),virtualKbd_body=document.getElementById("kbd_mka");over_sb||over_ft||virtualKbd_body&&"none"!==virtualKbd_body.style?that!==document.activeElement&&setTimeout((function(){that.focus()}),20):(that.last_val=that.value,that.sc.style.display="none",setTimeout((function(){that.sc.style.display="none"}),350))},addEvent(that,"blur",that.blurHandler);var cleanCache=function(val){var data=that.cache,c=[];if(val.length>0){for(var i=0;i<data.length;i++)void 0===data[i].ls&&c.push(data[i]);that.cache=c}else if(0==val.length){for(var i=0;i<data.length;i++)1==typeof data[i].ls&&c.push(data[i]);that.cache=c,that.searches=[]}},suggest=function(data){var val=that.value;that.cache.length>=that.cacheMax&&(that.cache=[]);for(var dataLen=data.length,index=0;index<dataLen;index++){var found;that.cache.some((function(el){return el.term==data[index].term&&el.language==data[index].language&&el.pinyn==data[index].pinyn&&el.transcription==data[index].transcription}))||that.cache.push(data[index])}if(data.length&&val.length>=o.minChars){data=o.filterItems(data,val);for(var s=header,i=0;i<data.length;i++)s+=o.renderItem(data[i],val);s+=footer,that.sc.innerHTML=s,that.updateSC(0)}else that.sc.style.display="none"};that.keydownHandler=function(e){var key=window.event?e.keyCode:e.which;if(38==key&&e.preventDefault(),(40==key||38==key)&&that.sc.innerHTML&&("none"!=that.sc.style.display||that.value.length>0)){var next,sel=that.sc.querySelector(".autocomplete-suggestion.hover"),footer=that.sc.querySelector(".autocomplete-footer.hover");if(sel)if(next=40==key?sel.nextSibling:sel.previousSibling){sel.className=sel.className.replace("hover",""),next.className+=" hover";var isNextFooter=hasClass(next,"autocomplete-footer"),isNextHeader=hasClass(next,"autocomplete-header");isNextFooter||isNextHeader||!next.hasAttribute("data-val")?(that.value=that.last_val,next=0):that.value=JSON.parse(decodeURIComponent(next.getAttribute("data-val"))).term}else sel.className=sel.className.replace("hover",""),that.value=that.last_val,next=0;else{footer?(next=40==key?that.sc.querySelector(".autocomplete-suggestion"):footer.previousSibling,footer.className=footer.className.replace("hover","")):next=40==key?that.sc.querySelector(".autocomplete-suggestion"):that.sc.childNodes[that.sc.childNodes.length-1],next.className+=" hover";var isNextFooter=hasClass(next,"autocomplete-footer"),isNextHeader=hasClass(next,"autocomplete-header");isNextFooter||isNextHeader||!next.hasAttribute("data-val")?(that.value=that.last_val,next=0):that.value=JSON.parse(decodeURIComponent(next.getAttribute("data-val"))).term}return enterUseSuggestion=!0,that.updateSC(0,next),!1}if(27==key)that.value=that.last_val,that.sc.style.display="none",enterUseSuggestion=!1;else if((13==key||9==key)&&!0===enterUseSuggestion){var sel=that.sc.querySelector(".autocomplete-suggestion.hover"),footer;(footer=that.sc.querySelector(".autocomplete-footer.hover"))&&(sel=footer),sel&&"none"!=that.sc.style.display&&(e.preventDefault(),o.onSelect(e,sel.getAttribute("data-val"),sel),setTimeout((function(){that.sc.style.display="none"}),20))}},addEvent(that,"keydown",that.keydownHandler),that.keyupHandler=function(e){cleanCache(that.value);var key=window.event?e.keyCode:e.which;if(!key||(key<35||key>40)&&13!=key&&27!=key){var val=deaccent(that.value);if(val.length>=o.minChars){if(val!=that.last_val){var tmpLast_val=that.last_val,alreadySearched;if(that.last_val=val,clearTimeout(that.timer),1==o.cache)if(1==that.searches.some((function(el){return val.indexOf(el)>-1}))&&(tmpLast_val.length<val.length||that.cache.some((function(el){return el.term.indexOf(val)>-1||el.pinyn&&el.pinyn.indexOf(val)>-1})))){var filtCache=[];if(32==key||189==key||109==key){var tmpVal=val.substr(0,val.length-1);filtCache=that.cache.filter((function(item){return 0==deaccent(item.term).indexOf(tmpVal+" ")||0==deaccent(item.term).indexOf(tmpVal+"-")||item.pinyn&&(0==deaccent(item.pinyn).indexOf(tmpVal+" ")||0==deaccent(item.pinyn).indexOf(tmpVal+"-"))}))}else{var matcher=new RegExp("^"+val,"i");filtCache=that.cache.filter((function(item){return matcher.test(deaccent(item.term))||item.pinyn&&matcher.test(deaccent(item.pinyn))||item.transcription&&matcher.test(deaccent(item.transcription))}))}if(filtCache.length>0)return void suggest(filtCache)}that.timer=setTimeout((function(){var existsInSearches;!that.searches.some((function(el){return el===val}))&&val.length>0&&that.searches.push(val),o.source(val,suggest)}),o.delay)}}else that.last_val=val,that.sc.style.display="none"}},addEvent(that,"keyup",that.keyupHandler),that.clickHandler=function(e){that.last_val="\n",that.keyupHandler(e)},o.minChars||addEvent(that,"click",that.clickHandler)}this.setHeader=function(str){header=str},this.setFooter=function(str){footer=str},this.destroy=function(){for(var i=0;i<elems.length;i++){var that=elems[i];removeEvent(window,"resize",that.updateSC),removeEvent(that,"blur",that.blurHandler),removeEvent(that,"click",that.clickHandler),removeEvent(that,"keydown",that.keydownHandler),removeEvent(that,"keyup",that.keyupHandler),that.autocompleteAttr?that.setAttribute("autocomplete",that.autocompleteAttr):that.removeAttribute("autocomplete"),document.body.removeChild(that.sc),that=null}}}function hasClass(el,className){return el.classList?el.classList.contains(className):new RegExp("\\b"+className+"\\b").test(el.className)}function addEvent(el,type,handler){el.attachEvent?el.attachEvent("on"+type,handler):el.addEventListener(type,handler)}function removeEvent(el,type,handler){el.detachEvent?el.detachEvent("on"+type,handler):el.removeEventListener(type,handler)}function live(elClass,event,cb,context){addEvent(context||document,event,(function(e){for(var found,el=e.target||e.srcElement;el&&!(found=hasClass(el,elClass));)el=el.parentElement;found&&cb.call(el,e)}))}}return autoComplete}();"function"==typeof define&&define.amd?define("autoComplete",(function(){return autoComplete})):"undefined"!=typeof module&&module.exports?module.exports=autoComplete:window.autoComplete=autoComplete;
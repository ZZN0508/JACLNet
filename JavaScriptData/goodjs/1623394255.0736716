YUI.add("af-beacon",function(e,t){"use strict";var n,a,r,o,i="error",s="info",c="perf",d=window,u={once:!1},f={code:!0,src:!0,time:!0},l=["ActionScript","Decompress fail"],m=["^resource://"],h={},g=[],p=!1,b=e.merge({enable:!0,beaconUncaughtErr:!1,beaconPageLoadPerf:!1,pathPrefix:"/_td_api/beacon",sampleSize:1,batch:!0,batchInterval:5},YUI.Env.Af&&YUI.Env.Af.settings&&YUI.Env.Af.settings.beacon,d.Af&&d.Af.config&&d.Af.config.beacon),S=e.merge(YUI.Env.Af&&YUI.Env.Af.settings&&YUI.Env.Af.settings.context,d.Af&&d.Af.context),v={os:e.UA&&e.UA.os};function E(e,t,n){if(!e||!t||!n)return!1;var a=e+":"+t+":"+n;return!!h[a]||(h[a]=!0,!1)}function _(t,n){var a,r,o,i,s,c,d,u,l=e.QueryString.stringify(t);if(l.length<=n)return l;for(a=[],r=[],i=0,s=(o=l.split("&")).length;i<s;i++)"_"===(c=o[i].split("="))[0].charAt(0)||f[c[0]]?a.push(o[i]):r.push(o[i]);return a=a.join("&"),(r=r.join("&"))&&(d=n-a.length,r.length>d&&((r=r.substring(0,d))?r+="&_trnc=1":r="_trnc=1")),u=[],a&&u.push(a),r&&u.push(r),u.join("&")}function y(){clearTimeout(a),e.Af.Beacon._sendBatch()}function A(){if(!p&&e.Af.Beacon.beaconPageLoadPerf){p=!0;var n,a,r,o,i,s=d.performance||d.webkitPerformance||d.msPerformance||d.mozPerformance||d.Performance||{},c={};s&&s.timing&&s.navigation?(o=s.navigation,n=(i=s.timing).navigationStart,c={navT:o.type,navS:n,fetS:i.fetchStart-n,dluS:i.domainLookupStart-n,dluE:i.domainLookupEnd-n,conS:i.connectStart-n,conE:i.connectEnd-n,reqS:i.requestStart-n,resS:i.responseStart-n,resE:i.responseEnd-n,domL:i.domLoading-n,domI:i.domInteractive-n,domS:i.domContentLoadedEventStart-n,domE:i.domContentLoadedEventEnd-n,domC:i.domComplete-n,lodS:i.loadEventStart-n,lodE:i.loadEventEnd-n},i.linkNegotiationStart&&i.linkNegotiationEnd&&(c.lnkS=i.linkNegotiationStart-n,c.lnkE=i.linkNegotiationEnd-n),i.unloadEventStart&&(c.uldS=i.unloadEventStart-n,c.uldE=i.unloadEventEnd-n),i.redirectStart&&(c.redC=o.redirectCount,c.redS=i.redirectStart-n,c.redE=i.redirectEnd-n),"number"==typeof i.secureConnectionStart&&(c.secS=i.secureConnectionStart>0?Math.max(1,i.secureConnectionStart-n):0)):(n=d.afPerfHeadStart,a=d.afPerfPageEnd,r=d.afPerfPageLoad,n&&r&&(c.lodE=r-n),n&&a&&(c.pagE=a-n)),c.lodE&&(c.code="pageload",c.time=c.lodE,e.Af.Beacon.perf(t,c))}}function P(){A(),y(),d.removeEventListener("unload",P,!1)}function L(){d.addEventListener("load",A,!1),d.addEventListener("unload",P,!1)}(r={_sampled:{},_sampleSize:{},getKey:function(e){return e&&e.type&&e.src?e.type+":"+e.src:"default"},isSampled:function(t){var n=this.getKey(t);return e.Lang.isBoolean(this._sampled[n])?this._sampled[n]:this._sampled["default"]},setSize:function(e,t){var n,a,r=this,o=r.getKey(t);return e=parseInt(e,10),isNaN(e)||e===r._sampleSize[o]||(r._sampled[o]=1===e||e>0&&1===(n=1,a=e,Math.floor(Math.random()*(a-n+1))+n),r._sampleSize[o]=e),r._sampled[o]}}).setSize(b.sampleSize),b.sampleSizeUncaughtErr&&r.setSize(b.sampleSizeUncaughtErr,{type:i,src:"rt"}),e.Array.each(["rid","bucket","device","site"],function(e){S[e]&&(v[e]=S[e]),f[e]=!0}),v=e.merge(v,b.meta||{}),e.namespace("Af").Beacon={enable_beaconrterr:b.beaconUncaughtErr,beaconPageLoadPerf:b.beaconPageLoadPerf,enable_batching:b.batch,batch_interval:b.batchInterval,meta:v,pathPrefix:b.pathPrefix,setSampleSize:function(e,t){return r.setSize(e,t)},isSampled:function(e){return r.isSampled(e)},_queryStringify:_,send:function(t,n,a){if(t){var r,o=new Image;o.onerror=function(e){var t=e instanceof Error?e.toString():e;i(a,t)},o.onload=function(){i(a)};try{return n&&e.Object.size(n)&&(n._rdn=(new Date).getTime().toString().substr(7),t+="?"+_(n,2048)),o.src=t,void(a&&setTimeout(function(){i(a,"aborted")},4e3))}catch(s){i(a,"path failed")}}else a&&a("invalid beacon path");function i(e,t){e&&!r&&(r=!0,e(t))}},_enqueue:function(e,t,n){g.push({beacon:{type:e,data:t},cb:n})},_dequeueAll:function(){return g.splice(0,g.length)},_sendBatch:function(){if(0!==g.length){var t,n=this._dequeueAll(),a=this.pathPrefix+"/batch";try{t={method:"POST",timeout:4e3,data:e.JSON.stringify(n),headers:{"Content-Type":"application/json"},on:{success:function(e){r(n)},failure:function(e,t){r(n,t.status+":"+t.statusText)}}},e.io(a,t)}catch(o){r(n,"path failed")}}function r(e,t){var n,a=e.length;for(n=0;n<a;n++)e[n]&&e[n].cb&&e[n].cb(t)}},xhr:function(t,n,a){if(t){var r;r={method:"GET",timeout:(n=n||{}).timeout||2e3,headers:n.headers||{},on:{success:function(e,t){a&&a({statusCode:t.status})},failure:function(e,t){a&&a({statusCode:t.status,statusText:t.statusText,respText:t.responseText})}}};try{t+="?"+_(n.query,2048),e.io(t,r)}catch(o){a&&a("querystring stringify failed")}}else a&&a("invalid xhr path")},error:function(t,n,a,r){var o,s,c;if(o=(r=e.merge(u,r)).callback,a)if(!this.isSampled({type:i,src:t})||this._shouldIgnoreError(a)||!0===r.once&&a.code&&E(i,t,a.code))o&&o();else{if(c=Object.prototype.toString.call(a),a){switch(c){case"[object String]":s={code:999,message:a};break;case"[object Error]":s={code:a.code||a.name||999,message:a.message,line:a.lineNumber||"",file:a.fileName||""};break;case"[object Object]":s=a;break;default:try{s={code:999,message:e.JSON.stringify(a)}}catch(d){}}s.message=s.message&&s.message.substring(0,300)||""}this._send(i,t,e.merge(this.meta,n,s),o)}else o&&o("missing error")},info:function(t,n,a){var r;r=(a=e.merge(u,a)).callback,n&&n.code?!this.isSampled({type:s,src:t})||!0===a.once&&E(s,t,n.code)?r&&r():this._send(s,t,e.merge(this.meta,n),r):r&&r("missing data.code")},perf:function(t,n,a){var r;r=(a=e.merge(u,a)).callback,n&&n.code&&e.Object.owns(n,"time")?!this.isSampled({type:c,src:t})||!0===a.once&&E(c,t,n.code)?r&&r():this._send(c,t,e.merge(this.meta,n),r):r&&r("missing data.code or data.time")},ignoreError:function(e){e&&l.push(e)},ignoreURL:function(e){e&&m.push(e)},_shouldIgnoreError:function(e){if(!e)return!0;var t,n,a;if(!(a="string"==typeof e?e:e.message))return!1;for(t=0,n=l.length;t<n;t++)if(a.match(l[t]))return!0;return!1},_shouldIgnoreURL:function(e){if(!e)return!1;var t,n;for(t=0,
n=m.length;t<n;t++)if(e.match(m[t]))return!0;return!1},_send:function(e,t,n,a){if(b.enable){var r=this.pathPrefix;r?e?n?(t&&(n.src=t),this.enable_batching?this._enqueue(e,n,a):this.send(r+"/"+e,n,a)):a&&a("no beacon data"):a&&a("no beacon type"):a&&a("no beacon pathPrefix")}else a&&a()}},n=d.onerror,d.onerror=function(t,a,r){var o,i=e.Af.Beacon;try{i.enable_beaconrterr&&!i._shouldIgnoreURL(a)&&(o={code:t.name,message:t.message||t,url:a&&a.substring(0,300),line:t.lineNumber||r||"",file:t.fileName||""},i.error("rt",{},o))}catch(s){}return"function"==typeof n&&n(t,a,r)},b.enable&&e.Af.Beacon.enable_batching&&(o=e.Af.Beacon.batch_interval,a=setInterval(function(){e.Af.Beacon._sendBatch()},1e3*o)),d.addEventListener?(d.addEventListener("pageshow",L,!1),L()):d.attachEvent&&(d.attachEvent("onload",A),d.attachEvent("onunload",A),d.attachEvent("onunload",y))},"@VERSION@",{requires:["json-stringify","querystring-stringify-simple","io-base"]});
define(["./../../desktop/components/helper","local/common/components/nsglibCommon"],function(e,t){function o(o){this.env="PROD",this.ready=!1,this.allowedEnvironments=["PROD","DEV"],this.config={system:e.getSystem(),browser:e.getBrowser(),messagingSenderId:"211794955562",firebaseeUrl:"https://www.gstatic.com/firebasejs/4.8.1/firebase.js",DEV:{host:"onet_dev",defaultTopics:[{displayName:"Pilne",codeName:"onet_dev_pilne"}]},PROD:{host:"onet.pl",defaultTopics:[{displayName:"Pilne",codeName:"onet.pl_pilne"}]}},this.topics=null,this.watchers={},this.messaging=null;try{this.config=Object.assign(this.config,o)}catch(e){}this.setStoredEnv(),t.push.getPushDevMode()&&this.setEnv("DEV"),this.synchronizeEnvs()}return o.prototype.saveTokenToLocalStorage=function(t){return!!t&&(e.localStorage.setItem("sg.push.token",t),!0)},o.prototype.getTokenFromLocalStorage=function(){return e.localStorage.getItem("sg.push.token")},o.prototype.setEnv=function(e){e&&this.getEnv()!==e&&this.allowedEnvironments.indexOf(e)>-1&&this.config[e]&&(this.env=e)},o.prototype.getEnv=function(){return this.env},o.prototype.getStoredEnv=function(){return e.localStorage.getItem("sg.push.enviroment")},o.prototype.setStoredEnv=function(){this.getStoredEnv()||e.localStorage.setItem("sg.push.enviroment",this.getEnv())},o.prototype.resetStoredEnv=function(){e.localStorage.setItem("sg.push.enviroment",""),this.setStoredEnv()},o.prototype.synchronizeEnvs=function(){this.getStoredEnv()!==this.getEnv()&&(this.topics=null,this.clearStoredData(),this.resetStoredEnv())},o.prototype.getHostFormConfig=function(){var e=this.getEnv();return!(!this.config[e]||!this.config[e].host)&&this.config[e].host},o.prototype.isDevMode=function(){return"DEV"===this.getEnv()},o.prototype.on=function(e,t){e&&"function"==typeof t&&(this.watchers[e]||(this.watchers[e]=[]),this.watchers[e].push(t))},o.prototype.fire=function(e){var t;if(e&&this.watchers[e]){var o=0;for(this.watchers[e].length;t=this.watchers[e][o];o++)try{t.apply(this,arguments)}catch(e){console.error(e)}}},o.prototype.checkBrowserSupport=function(){var e=this.config.system,t=this.config.browser;return new Promise(function(o){if(window.navigator&&navigator.serviceWorker&&"PushManager"in window)if(!0===("Windows"===e&&("firefox"===t||"chrome"===t)||"MacOsX"===e&&("firefox"===t||"chrome"===t)||"Android"===e&&("firefox"===t||"chrome"===t)&&window.enablePush)){try{if(localStorage.setItem("sg.push.ls.test","ok"),"ok"!==localStorage.getItem("sg.push.ls.test"))return void o(!1)}catch(e){return void o(!1)}if("chrome"===t){var n=window.RequestFileSystem||window.webkitRequestFileSystem;n?n(window.TEMPORARY,100,function(e){o(!0)},function(e){o(!1)}):o(!1)}else o(!0)}else o(!1);else o(!1)})},o.prototype.saveSubscribedTopicsToLocalStorage=function(t){t&&e.localStorage.setItem("sg.push.notificationTopics",JSON.stringify(t))},o.prototype.checkMigrationStatus=function(){return e.localStorage.getItem("sg.pushTokenStatus")&&"sent"===e.localStorage.getItem("sg.pushTokenStatus")},o.prototype.initFirebase=function(e){if(e){0===firebase.apps.length?(firebase.initializeApp({messagingSenderId:this.config.messagingSenderId}),this.messaging=firebase.messaging(),this.messaging.useServiceWorker(e)):messaging=firebase.messaging(firebase.apps[0])}},o.prototype.runFirebaseApp=function(){var e=this;navigator.serviceWorker.getRegistration().then(function(t){e.initFirebase(t),e.messaging.onTokenRefresh(function(){require(["local/common/push/tokenApi"],function(e){e.refreshToken()})}),e.messaging.onMessage(function(t){require(["local/common/push/notificationHandler"],function(o){o(t),e.fire("onMessage",t)})}),e.messaging.getToken().then(function(t){t?e.callOnReady(t):console.log("Messaging: Token not returned from firebase.")}).catch(function(e){console.warn(e)})})},o.prototype.clearStoredData=function(){e.localStorage.setItem("sg.push.notificationTopics","")},o.prototype.callOnReady=function(e){var t=this;function o(){t.ready=!0,t.fire("onReady")}e?(this.token=e,require(["local/common/push/topics"],function(e){t.getTokenFromLocalStorage()&&t.getTokenFromLocalStorage()===t.token&&e.getSubscribedTopics()?o():require(["local/common/push/pushPlatformApi"],function(n){n.sendTokenToServer(e.getSubscribedTopics()).then(function(e){t.saveTokenToLocalStorage(t.token),o()})})})):this.fire("onError")},o.prototype.run=function(){var e=this;function o(){var o="mobile"===t.ress.getRessVersion()?"/push-mob-service-worker4.js?V=450":"/push-service-worker4.js?V=450";navigator.serviceWorker.register(o,{scope:"/"}).then(function(){e.fire("onRegister"),e.runFirebaseApp()},function(e){console.error("Service worker registration failed: "+e.message)})}this.checkBrowserSupport().then(function(t){t&&require([e.config.firebaseeUrl],o)})},o});